<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="viewport-fit=cover,width=device-width,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#FFFFFF" />
  <meta name="color-scheme" content="light" />
  <title>MedicalDebrief by CVA - Débrief</title>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
    rel="stylesheet"
  />
  <!-- JS managers -->
  <script src="js/storage.js" defer></script>
  <script src="js/auth-manager.js" defer></script>
  <script src="js/visits-manager.js" defer></script>
  <style>
    :root {
      --brand-light: #37A7C4;
      --brand-medium: #2C89A0;
      --brand-dark: #1E5F6E;
    }
    body {
      background: #F5F9FA;
      font-family: -apple-system,BlinkMacSystemFont,sans-serif;
      padding-top: 80px;
      padding-bottom: 20px;
    }
    .form-section {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
    }
    .ios-input {
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(55,167,196,0.2);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 16px;
      width: 100%;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }
    .app-button {
      background: linear-gradient(135deg, var(--brand-light), var(--brand-medium));
      border-radius: 12px;
      padding: 12px 24px;
      color: white;
      font-weight: 600;
      display: inline-block;
      text-align: center;
      transition: transform 0.2s;
    }
    .app-button:active {
      transform: scale(0.97);
    }
    .analysis-box, .questions-box, .final-box {
      background: #F9FEFF;
      border: 1px solid rgba(55,167,196,0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 8px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .analysis-item {
      margin-bottom: 12px;
    }
    .analysis-item-title {
      font-weight: 600;
      color: var(--brand-dark);
    }
    .analysis-item-content {
      font-size: 14px;
      color: var(--brand-dark);
      opacity: 0.9;
    }
    .questions-box ul {
      list-style: disc;
      margin-left: 1.3rem;
    }
  </style>
</head>
<body>
  <!-- Barre de nav -->
  <nav class="fixed top-0 w-full bg-white shadow-sm flex items-center justify-between p-4">
    <a href="login.html" class="text-[var(--brand-dark)]">Déconnexion</a>
    <span class="font-bold">MedicalDebrief by CVA</span>
    <a href="list-visits.html" class="text-[var(--brand-light)]">Mes visites</a>
  </nav>

  <main class="max-w-xl mx-auto mt-4 px-4">
    <!-- ÉTAPE 1 -->
    <div class="form-section">
      <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-6">
        Étape 1 : Informations & Analyse IA
      </h2>
      <label class="block mb-1 text-sm text-[var(--brand-dark)]">Médecin</label>
      <input type="text" id="doctorInput" class="ios-input" placeholder="Dr Dupont" />
      
      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-4">Date de visite</label>
      <input type="date" id="dateInput" class="ios-input" />

      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-4">Compte-rendu initial</label>
      <textarea
        class="ios-input h-32 resize-none"
        id="notesInput"
        placeholder="Décrivez l'échange..."
      ></textarea>

      <button id="analyzeBtn" class="app-button w-full mt-4">
        Analyser (IA)
      </button>

      <!-- Analyse + Questions -->
      <div id="analysisBox" class="analysis-box mt-6" style="display:none;"></div>
      <div id="questionsBox" class="questions-box mt-4" style="display:none;"></div>
    </div>

    <!-- ÉTAPE 2 -->
    <div class="form-section" id="step2Section" style="display:none;">
      <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-2">
        Étape 2 : Réponses & Synthèse finale
      </h2>
      <p class="text-sm text-[var(--brand-dark)] opacity-80">
        Répondez aux questions, puis demandez à l'IA d'intégrer vos réponses pour générer la synthèse finale :
      </p>
      <textarea
        id="answersInput"
        class="ios-input h-24 resize-none mt-2"
        placeholder="Vos réponses ou précisions..."
      ></textarea>

      <button id="finalSynthesisBtn" class="app-button w-full mt-4">
        Générer la Synthèse Finale (IA)
      </button>

      <!-- Boîte qui affiche la finalSummary -->
      <div id="finalBox" class="final-box mt-4" style="display:none;"></div>

      <button id="saveBtn" class="app-button w-full mt-4" style="background:#2C89A0;">
        Enregistrer en local
      </button>
    </div>
  </main>

  <footer class="text-center pt-4 mt-4">
    <p class="text-[var(--brand-dark)] opacity-60 text-sm">
      © 2025 MedicalDebrief by CVA
    </p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const auth = new AuthManager();
    const currentUser = auth.getCurrentUser();
    if (!currentUser) {
      window.location.href = "login.html";
    }

    const visitsManager = new VisitsManager();

    // Étape 1
    const doctorInput = document.getElementById('doctorInput');
    const dateInput = document.getElementById('dateInput');
    const notesInput = document.getElementById('notesInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisBox = document.getElementById('analysisBox');
    const questionsBox = document.getElementById('questionsBox');

    // Étape 2
    const step2Section = document.getElementById('step2Section');
    const answersInput = document.getElementById('answersInput');
    const finalSynthesisBtn = document.getElementById('finalSynthesisBtn');
    const finalBox = document.getElementById('finalBox');
    const saveBtn = document.getElementById('saveBtn');

    // Worker URL
    const workerURL = "https://votre-worker.cloudflare.../";

    // Variables pour stocker l'analyse, questions, finalSummary
    let currentAnalysis = [];
    let currentQuestions = [];
    let finalSummary = "";

    // Étape 1: ANALYSIS
    analyzeBtn.addEventListener('click', async () => {
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value;
      const notes = notesInput.value.trim();
      if(!docName || !visitDate || !notes) {
        alert("Merci de remplir tous les champs (médecin, date, notes).");
        return;
      }

      // Requête
      const bodyReq = {
        action: "analysis",
        data: {
          patientInfo: { salesRep: currentUser },
          visitNotes: notes
        }
      };

      try {
        const resp = await fetch(workerURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyReq)
        });
        const result = await resp.json();
        if(result.error) {
          analysisBox.style.display = "block";
          analysisBox.textContent = "Erreur IA: " + result.error;
          questionsBox.style.display = "none";
          return;
        }
        // On suppose { analysis: [...], questions: [...] }
        currentAnalysis = result.analysis || [];
        currentQuestions = result.questions || [];

        showAnalysis(currentAnalysis);
        showQuestions(currentQuestions);

        // On affiche l'étape 2
        step2Section.style.display = "block";

      } catch(e) {
        console.error(e);
        analysisBox.style.display = "block";
        analysisBox.textContent = "Erreur: " + e.message;
      }
    });

    // Étape 2: FINAL SYNTHESIS
    finalSynthesisBtn.addEventListener('click', async () => {
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value;
      const notes = notesInput.value.trim();
      const userAnswers = answersInput.value.trim();

      // On appelle le Worker avec action = 'final_synthesis'
      const bodyReq = {
        action: "final_synthesis",
        data: {
          patientInfo: { salesRep: currentUser },
          visitNotes: notes,
          analysis: currentAnalysis,   // tableau
          questions: currentQuestions, // tableau
          answers: userAnswers
        }
      };

      try {
        const resp = await fetch(workerURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyReq)
        });
        const result = await resp.json();
        if(result.error) {
          finalBox.style.display = "block";
          finalBox.textContent = "Erreur IA: " + result.error;
          return;
        }
        // On suppose { finalSummary: "..." }
        finalSummary = result.finalSummary || "Pas de synthèse finale.";

        finalBox.style.display = "block";
        finalBox.textContent = finalSummary;

      } catch(e) {
        console.error(e);
        finalBox.style.display = "block";
        finalBox.textContent = "Erreur: " + e.message;
      }
    });

    // Enregistrer la visite complète en local
    saveBtn.addEventListener('click', () => {
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value;
      const notes = notesInput.value.trim();
      const userAnswers = answersInput.value.trim();

      const objToStore = {
        user: currentUser,
        doctor: docName,
        date: visitDate,
        notes: notes,
        analysis: JSON.stringify(currentAnalysis),
        questions: JSON.stringify(currentQuestions),
        answers: userAnswers,
        finalSummary: finalSummary,
        createdAt: new Date().toISOString()
      };
      visitsManager.saveVisit(objToStore);
      alert("Enregistré dans l'historique local !");
    });

    function showAnalysis(analysisArr) {
      analysisBox.style.display = "block";
      if(!analysisArr || !analysisArr.length) {
        analysisBox.textContent = "(Analyse vide)";
        return;
      }
      let html = "";
      analysisArr.forEach(item => {
        html += `
          <div class="analysis-item">
            <div class="analysis-item-title">${item.title}</div>
            <div class="analysis-item-content">${item.content}</div>
          </div>
        `;
      });
      analysisBox.innerHTML = html;
    }
    function showQuestions(qArr) {
      questionsBox.style.display = "block";
      if(!qArr || !qArr.length) {
        questionsBox.textContent = "(Aucune question)";
        return;
      }
      let html = "<ul>";
      qArr.forEach(q => {
        html += `<li><strong>${q}</strong></li>`;
      });
      html += "</ul>";
      questionsBox.innerHTML = html;
    }
  });
  </script>
</body>
</html>
