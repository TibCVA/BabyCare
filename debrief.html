<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#FFFFFF" />
  <meta name="color-scheme" content="light" />
  <title>MedicalDebrief by CVA - Débrief</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
  <!-- JS managers -->
  <script src="js/storage.js" defer></script>
  <script src="js/auth-manager.js" defer></script>
  <script src="js/visits-manager.js" defer></script>
  <style>
    :root {
      --brand-light: #37A7C4;
      --brand-medium: #2C89A0;
      --brand-dark: #1E5F6E;
    }
    body {
      background: #F5F9FA;
      font-family: -apple-system,BlinkMacSystemFont,sans-serif;
      padding-top: 100px;
      padding-bottom: 20px;
    }
    .form-section {
      background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px;
    }
    .ios-input {
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(55,167,196,0.2);
      border-radius: 12px;
      padding: 12px 16px; font-size: 16px;
      width: 100%; margin-bottom: 8px;
    }
    .app-button {
      background: linear-gradient(135deg, var(--brand-light), var(--brand-medium));
      border-radius: 12px;
      padding: 12px 24px; color: white; font-weight: 600;
      display: inline-block; text-align: center;
    }
    /* Boîte pour l'analyse stylée */
    .analysis-box, .questions-box {
      background: #FAFEFF;
      border: 1px solid rgba(55,167,196,0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 8px;
    }
    .analysis-item {
      margin-bottom: 12px;
    }
    .analysis-item-title {
      font-weight: 600; color: var(--brand-dark);
    }
    .analysis-item-content {
      font-size: 14px; color: var(--brand-dark); opacity: 0.9;
    }
  </style>
</head>
<body>
  <nav class="fixed top-0 w-full bg-white shadow-sm flex items-center justify-between p-4">
    <a href="login.html" class="text-[var(--brand-dark)]">Déconnexion</a>
    <span class="font-bold">MedicalDebrief by CVA</span>
    <a href="list-visits.html" class="text-[var(--brand-light)]">Mes visites</a>
  </nav>

  <main class="max-w-xl mx-auto mt-8 px-4">
    <!-- Formulaire standard: Médecin / Date / Notes -->
    <div class="form-section">
      <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-6">
        Informations de la visite
      </h2>
      <label class="block mb-1 text-sm text-[var(--brand-dark)]">Médecin</label>
      <input type="text" id="doctorInput" class="ios-input" placeholder="Dr Dupont" />
      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-4">Date de visite</label>
      <input type="date" id="dateInput" class="ios-input" />
    </div>

    <div class="form-section">
      <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-6">
        Notes sur l'échange
      </h2>
      <textarea class="ios-input h-32 resize-none" id="notesInput"
        placeholder="Votre débrief de l'échange..."></textarea>
    </div>

    <!-- Boîte d'analyse -->
    <div class="form-section">
      <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-2">
        Analyse de Claude
      </h2>
      <div id="analysisBox" class="analysis-box">
        <p class="text-sm text-gray-500 italic">Aucune analyse pour l'instant</p>
      </div>
    </div>

    <!-- Boîte de questions de l'IA -->
    <div class="form-section">
      <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-2">
        Questions à approfondir
      </h2>
      <div id="questionsBox" class="questions-box">
        <p class="text-sm text-gray-500 italic">Pas encore de questions</p>
      </div>
      <!-- Zone de réponses du sales rep -->
      <textarea id="answersInput" class="ios-input h-24 resize-none mt-2"
        placeholder="Vos réponses ou précisions..."></textarea>
    </div>

    <button id="saveBtn" class="app-button w-full mt-4">
      Analyser & Enregistrer
    </button>
  </main>

  <footer class="text-center pt-4 mt-8">
    <p class="text-[var(--brand-dark)] opacity-60 text-sm">
      © 2025 MedicalDebrief by CVA
    </p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const auth = new AuthManager();
    const currentUser = auth.getCurrentUser();
    if(!currentUser) {
      window.location.href = "login.html";
    }

    const visitsManager = new VisitsManager();

    const doctorInput = document.getElementById('doctorInput');
    const dateInput = document.getElementById('dateInput');
    const notesInput = document.getElementById('notesInput');
    const analysisBox = document.getElementById('analysisBox');
    const questionsBox = document.getElementById('questionsBox');
    const answersInput = document.getElementById('answersInput');
    const saveBtn = document.getElementById('saveBtn');

    // URL de votre Worker Cloudflare
    const workerURL = "https://votre-worker.cloudflare.../"; // à adapter

    saveBtn.addEventListener('click', async ()=>{
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value;
      const notes = notesInput.value.trim();
      if(!docName || !visitDate || !notes) {
        alert("Merci de remplir tous les champs.");
        return;
      }

      // Construire l'objet qu'on envoie au Worker
      const bodyReq = {
        action: "analysis",
        data: {
          patientInfo: {
            salesRep: currentUser
          },
          visitNotes: notes
          // => Ajoutez d'autres infos si besoin
        }
      };

      try {
        // Appel Worker
        const resp = await fetch(workerURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyReq)
        });
        const result = await resp.json();
        
        if(result.error) {
          // Erreur renvoyée par le Worker
          analysisBox.innerHTML = `<p class="text-sm text-red-500">Erreur Worker: ${result.error}</p>`;
          questionsBox.innerHTML = `<p class="text-sm text-red-500">Impossible de générer des questions</p>`;
        } else {
          // On suppose qu'on a un JSON avec { analysis: [...], questions: [...] }
          displayAnalysis(result.analysis);
          displayQuestions(result.questions);
        }
      } catch(e) {
        console.error(e);
        analysisBox.innerHTML = `<p class="text-sm text-red-500">${e.message}</p>`;
      }

      // Ensuite, on enregistre localement
      const finalObj = {
        user: currentUser,
        doctor: docName,
        date: visitDate,
        notes: notes,
        // On récupère ce qui est affiché
        analysis: analysisBox.innerText || "",
        questions: questionsBox.innerText || "",
        answers: answersInput.value,
        createdAt: new Date().toISOString()
      };
      visitsManager.saveVisit(finalObj);

      alert("Visite enregistrée (avec analyse + questions).");
    });

    function displayAnalysis(analysisArray) {
      // analysisArray est sensé être un tableau d'objets {title, content}
      if(!analysisArray || !Array.isArray(analysisArray)) {
        analysisBox.innerHTML = `<p class="text-sm text-gray-500 italic">Aucune analyse exploitable</p>`;
        return;
      }
      let html = "";
      analysisArray.forEach(item => {
        html += `
          <div class="analysis-item">
            <div class="analysis-item-title">${item.title}</div>
            <div class="analysis-item-content">${item.content}</div>
          </div>
        `;
      });
      analysisBox.innerHTML = html;
    }

    function displayQuestions(questionsArray) {
      // questionsArray est un tableau de chaînes
      if(!questionsArray || !Array.isArray(questionsArray) || questionsArray.length === 0) {
        questionsBox.innerHTML = `<p class="text-sm text-gray-500 italic">Pas de questions spécifiques</p>`;
        return;
      }
      let html = "<ul class='list-disc list-inside'>";
      questionsArray.forEach(q => {
        html += `<li class="mb-2">${q}</li>`;
      });
      html += "</ul>";
      questionsBox.innerHTML = html;
    }

  });
  </script>
</body>
</html>
