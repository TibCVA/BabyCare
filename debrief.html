<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="viewport-fit=cover,width=device-width,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#FFFFFF" />
  <meta name="color-scheme" content="light" />
  <title>MedicalDebrief by CVA - D√©brief</title>

  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
    rel="stylesheet"
  />

  <script src="js/storage.js" defer></script>
  <script src="js/auth-manager.js" defer></script>
  <script src="js/visits-manager.js" defer></script>

  <style>
    :root {
      --brand-light: #37A7C4;
      --brand-medium: #2C89A0;
      --brand-dark: #1E5F6E;
    }

    /* Nouveau design iOS-like */
    body {
      background: #f8fafc;
      font-family: -apple-system,BlinkMacSystemFont,sans-serif;
      padding-top: 80px;
      padding-bottom: 20px;
    }

    .form-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(30, 95, 110, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transform: translateY(0);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .form-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(30, 95, 110, 0.15);
    }

    .ios-input {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(55, 167, 196, 0.15);
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(55, 167, 196, 0.05);
      width: 100%;
      margin-bottom: 6px;
    }
    .ios-input:focus {
      border-color: var(--brand-light);
      box-shadow: 0 0 0 3px rgba(55, 167, 196, 0.15);
    }

    /* Animation des cartes IA */
    @keyframes floatIn {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .analysis-box,
    .questions-box,
    .final-box {
      animation: floatIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      background: linear-gradient(145deg, #ffffff, #f0f9fb);
      border: 1px solid rgba(55, 167, 196, 0.1);
      box-shadow: 0 4px 24px rgba(55, 167, 196, 0.08);
      position: relative;
      overflow: hidden;
      padding: 14px;
      margin-top: 10px;
      border-radius: 14px;
    }
    .analysis-box::before,
    .questions-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand-light), var(--brand-dark));
      opacity: 0.1;
    }

    /* Nouveau spinner moderne */
    .loading-ring {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 3px solid rgba(55, 167, 196, 0.1);
      border-top-color: var(--brand-light);
      animation: spin 1s linear infinite;
      position: relative;
      margin: 0 auto 6px auto;
    }
    .loading-ring::after {
      content: '';
      position: absolute;
      top: -3px; left: -3px; right: -3px; bottom: -3px;
      border-radius: 50%;
      border: 3px solid transparent;
      border-bottom-color: var(--brand-dark);
      animation: spinReverse 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes spinReverse {
      to { transform: rotate(-360deg); }
    }

    /* IA response effet de live text */
    .ai-response {
      position: relative;
      padding-left: 32px;
    }
    .ai-response::before {
      content: '‚ú¶';
      position: absolute;
      left: 0;
      top: 2px;
      color: var(--brand-light);
      font-size: 24px;
      animation: sparkle 1.5s infinite;
    }
    @keyframes sparkle {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.1); }
    }
  </style>
</head>
<body>
  <!-- Barre de nav -->
  <nav class="fixed top-0 w-full bg-white shadow-sm flex items-center justify-between p-3">
    <a href="login.html" class="text-[var(--brand-dark)] font-medium">D√©connexion</a>
    <span class="font-bold">MedicalDebrief by CVA</span>
    <a href="list-visits.html" class="text-[var(--brand-light)] font-medium">Mes visites</a>
  </nav>

  <main class="max-w-xl mx-auto mt-4 px-4">
    <!-- √âTAPE 1 -->
    <div class="form-section">
      <h2 class="text-base font-semibold text-[var(--brand-dark)] mb-4">
        √âtape 1 : Informations & Analyse IA
      </h2>

      <label class="block mb-1 text-sm text-[var(--brand-dark)]">Type de visite</label>
      <select id="visitTypeSelect" class="ios-input">
        <option value="">-- S√©lectionnez --</option>
        <option value="Prospection">Prospection</option>
        <option value="Suivi">Suivi</option>
        <option value="Routini√®re">Routini√®re</option>
        <option value="KAM">KAM</option>
      </select>

      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-2">Type de contact</label>
      <select id="contactTypeSelect" class="ios-input">
        <option value="">-- S√©lectionnez --</option>
        <option value="M√©decin">M√©decin</option>
        <option value="Pharmacien">Pharmacien</option>
        <option value="Autre">Autre</option>
      </select>

      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-2">M√©decin / Contact</label>
      <input type="text" id="doctorInput" class="ios-input" placeholder="Dr Dupont" />

      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-2">Date de visite</label>
      <input type="date" id="dateInput" class="ios-input" />

      <label class="block mb-1 text-sm text-[var(--brand-dark)] mt-2">Compte-rendu initial</label>
      <textarea id="notesInput" class="ios-input h-20 resize-none" placeholder="D√©crivez l'√©change..."></textarea>

      <button id="analyzeBtn" class="app-button w-full mt-3">
        Analyser (IA)
      </button>

      <!-- Spinner √©tape 1 -->
      <div id="loadingStep1" class="text-center hidden mt-4">
        <div class="loading-ring"></div>
        <p class="text-[var(--brand-dark)] text-sm">Analyse en cours...</p>
      </div>

      <!-- Analyse + Questions -->
      <div id="analysisBox" class="analysis-box" style="display:none;">
        <div class="ai-response" id="analysisResponse"></div>
      </div>

      <div id="questionsBox" class="questions-box" style="display:none;">
        <ol id="questionsList" class="ml-4 text-sm"></ol>
      </div>
    </div>

    <!-- √âTAPE 2 -->
    <div class="form-section" id="step2Section" style="display:none;">
      <h2 class="text-base font-semibold text-[var(--brand-dark)] mb-2">
        √âtape 2 : R√©ponses & Synth√®se finale
      </h2>
      <textarea
        id="answersInput"
        class="ios-input h-20 resize-none"
        placeholder="R√©pondez aux questions ci-dessus..."
      ></textarea>

      <button id="finalSynthesisBtn" class="app-button w-full mt-3">
        G√©n√©rer la Synth√®se Finale (IA)
      </button>

      <!-- Spinner √©tape 2 -->
      <div id="loadingStep2" class="text-center hidden mt-4">
        <div class="loading-ring"></div>
        <p class="text-[var(--brand-dark)] text-sm">G√©n√©ration de la synth√®se...</p>
      </div>

      <div id="finalBox" class="final-box" style="display:none;">
        <div class="ai-response" id="finalResponse"></div>
        <div class="mt-4 flex items-center space-x-3 border-t border-[rgba(55,167,196,0.1)] pt-3">
          <button onclick="copyToClipboard()" class="text-[var(--brand-dark)] hover:opacity-80 transition-opacity">
            üìã Copier
          </button>
          <button onclick="shareContent()" class="text-[var(--brand-dark)] hover:opacity-80 transition-opacity">
            ‚ÜóÔ∏è Partager
          </button>
        </div>
      </div>

      <button id="saveBtn" class="app-button w-full mt-3" style="background:#2C89A0;">
        Enregistrer en local
      </button>
    </div>
  </main>

  <footer class="text-center pt-2 mt-4 mb-2">
    <p class="text-[var(--brand-dark)] opacity-60 text-sm">
      ¬© 2025 MedicalDebrief by CVA
    </p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const auth = new AuthManager();
    const currentUser = auth.getCurrentUser();
    if(!currentUser) {
      window.location.href = "login.html";
    }
    const visitsManager = new VisitsManager();

    // √âl√©ments
    const visitTypeSelect = document.getElementById('visitTypeSelect');
    const contactTypeSelect = document.getElementById('contactTypeSelect');
    const doctorInput = document.getElementById('doctorInput');
    const dateInput = document.getElementById('dateInput');
    const notesInput = document.getElementById('notesInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisBox = document.getElementById('analysisBox');
    const analysisResponse = document.getElementById('analysisResponse');
    const questionsBox = document.getElementById('questionsBox');
    const questionsList = document.getElementById('questionsList');
    const loadingStep1 = document.getElementById('loadingStep1');

    const step2Section = document.getElementById('step2Section');
    const answersInput = document.getElementById('answersInput');
    const finalSynthesisBtn = document.getElementById('finalSynthesisBtn');
    const loadingStep2 = document.getElementById('loadingStep2');
    const finalBox = document.getElementById('finalBox');
    const finalResponse = document.getElementById('finalResponse');
    const saveBtn = document.getElementById('saveBtn');

    // Worker URL
    const workerURL = "https://royal-king-f79d.b00135522.workers.dev/";

    let currentAnalysis = [];
    let currentQuestions = [];
    let finalSummary = "";

    // √âtape 1: analysis
    analyzeBtn.addEventListener('click', async () => {
      const visitType = visitTypeSelect.value;
      const contactType = contactTypeSelect.value;
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value;
      const notes = notesInput.value.trim();

      if(!docName || !visitDate || !notes) {
        alert("Veuillez renseigner contact, date et compte-rendu.");
        return;
      }

      // Afficher le spinner
      loadingStep1.classList.remove('hidden');
      analysisBox.style.display = "none";
      questionsBox.style.display = "none";

      const bodyReq = {
        action: "analysis",
        data: {
          salesRep: currentUser,
          visitType: visitType,
          contactType: contactType,
          visitNotes: notes
        }
      };

      try {
        const resp = await fetch(workerURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyReq)
        });
        const result = await resp.json();

        loadingStep1.classList.add('hidden');

        if(result.error) {
          alert("Erreur IA: " + result.error);
          return;
        }
        currentAnalysis = result.analysis || [];
        currentQuestions = result.questions || [];

        showAnalysis(currentAnalysis);
        showQuestions(currentQuestions);
        step2Section.style.display = "block";

      } catch(e) {
        loadingStep1.classList.add('hidden');
        console.error(e);
        alert("Erreur: " + e.message);
      }
    });

    // √âtape 2: final_synthesis
    finalSynthesisBtn.addEventListener('click', async () => {
      const visitType = visitTypeSelect.value;
      const contactType = contactTypeSelect.value;
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value;
      const notes = notesInput.value.trim();
      const userAnswers = answersInput.value.trim();

      loadingStep2.classList.remove('hidden');
      finalBox.style.display = "none";

      const bodyReq = {
        action: "final_synthesis",
        data: {
          salesRep: currentUser,
          visitType: visitType,
          contactType: contactType,
          visitNotes: notes,
          analysis: currentAnalysis,
          questions: currentQuestions,
          answers: userAnswers
        }
      };

      try {
        const resp = await fetch(workerURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyReq)
        });
        const result = await resp.json();

        loadingStep2.classList.add('hidden');

        if(result.error) {
          alert("Erreur IA: " + result.error);
          return;
        }
        finalSummary = result.finalSummary || "(Pas de synth√®se)";
        finalResponse.textContent = finalSummary; 
        finalBox.style.display = "block";

      } catch(e) {
        loadingStep2.classList.add('hidden');
        console.error(e);
        alert("Erreur: " + e.message);
      }
    });

    // Enregistrement local
    saveBtn.addEventListener('click', () => {
      const visitType = visitTypeSelect.value;
      const contactType = contactTypeSelect.value;
      const docName = doctorInput.value.trim();
      const visitDate = dateInput.value.trim();
      const notes = notesInput.value.trim();
      const userAnswers = answersInput.value.trim();

      const objToStore = {
        user: currentUser,
        visitType: visitType,
        contactType: contactType,
        doctor: docName,
        date: visitDate,
        notes: notes,
        analysis: JSON.stringify(currentAnalysis),
        questions: JSON.stringify(currentQuestions),
        answers: userAnswers,
        finalSummary: finalSummary,
        createdAt: new Date().toISOString()
      };
      visitsManager.saveVisit(objToStore);
      alert("Enregistr√© dans l'historique local !");
    });

    // Helpers
    function showAnalysis(arr) {
      if(!arr.length) {
        analysisResponse.textContent = "(Analyse vide)";
        analysisBox.style.display = "block";
        return;
      }
      let text = "";
      arr.forEach(item => {
        text += `${item.title}: ${item.content}\n\n`;
      });
      analysisResponse.textContent = text.trim();
      analysisBox.style.display = "block";
    }

    function showQuestions(qArr) {
      if(!qArr.length) {
        questionsBox.style.display = "block";
        questionsList.innerHTML = "<li>(Aucune question)</li>";
        return;
      }
      questionsList.innerHTML = "";
      qArr.forEach(q => {
        const li = document.createElement('li');
        li.textContent = q;
        questionsList.appendChild(li);
      });
      questionsBox.style.display = "block";
    }
  });

  // Bouton "Copier" pour la synth√®se
  function copyToClipboard() {
    const text = document.getElementById('finalResponse')?.textContent || '';
    navigator.clipboard.writeText(text).then(() => {
      alert("Synth√®se copi√©e !");
    }, () => {
      alert("√âchec de la copie.");
    });
  }

  // Bouton "Partager"
  function shareContent() {
    const text = document.getElementById('finalResponse')?.textContent || '';
    if(navigator.share) {
      navigator.share({ text })
        .catch(err => console.log('Partage annul√©', err));
    } else {
      alert("API de partage non support√©e sur ce navigateur.");
    }
  }
  </script>
</body>
</html>